# Define protected branches
protected_branches="main|develop|test|prod"

# Define authorized users
authorized_users="kerry.blig12@gmail.com"

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Get git user email
user_email=$(git config user.email)

echo "ğŸš€ Pre-push hook running..."
echo "ğŸ“§ User email: $user_email"
echo "ğŸŒ¿ Current branch: $current_branch"

# Check if current branch is protected
if echo "$current_branch" | grep -qE "^($protected_branches)$"; then
    echo "ğŸ”’ Branch '$current_branch' is protected"
    
    # Check if user is authorized
    if echo "$user_email" | grep -qE "^($authorized_users)$"; then
        echo "âœ… User '$user_email' is authorized to push to '$current_branch'"
    else
        echo "âŒ Error: User '$user_email' is not authorized to push to protected branch '$current_branch'"
        echo "ğŸš« Push blocked!"
        exit 1
    fi
else
    echo "â„¹ï¸  Branch '$current_branch' is not protected, push allowed for any user"
fi

# Run comprehensive checks before push
echo "ğŸ” Running final TypeScript type check..."
if ! pnpm run type-check; then
    echo "âŒ TypeScript type check failed!"
    echo "ğŸš« Push blocked - please fix type errors before pushing"
    exit 1
fi

echo "ğŸ” Running final ESLint check..."
if ! pnpm run lint; then
    echo "âŒ ESLint check failed!"
    echo "ï¿½ Push blocked - please fix all linting errors and warnings before pushing"
    exit 1
fi

# Optional: Run build to ensure everything compiles
echo "ğŸ—ï¸  Running build check..."
if ! pnpm build; then
    echo "âŒ Build failed!"
    echo "ğŸš« Push blocked - please fix build errors before pushing"
    exit 1
fi

echo "âœ… All pre-push checks passed! Proceeding with push..."